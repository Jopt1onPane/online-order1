# 网站部署完整教程

## 📋 部署方案概览

本教程将指导您将餐厅点餐网站部署到互联网上，使其可以被公开访问。

### 推荐方案：前后端分离部署
- **前端**：Vercel（免费，自动 HTTPS）
- **后端**：Railway 或 Render（免费额度）
- **数据库**：MongoDB Atlas（免费 512MB）

---

## 🗄️ 第一步：设置 MongoDB 数据库

### 1.1 注册 MongoDB Atlas 账号
1. 访问：https://www.mongodb.com/cloud/atlas
2. 点击 "Try Free" 注册账号
3. 选择免费套餐（M0 - Free）

### 1.2 创建数据库集群
1. 选择云服务商（AWS/Google Cloud/Azure）和区域（选择离您最近的）
2. 集群名称：保持默认或自定义
3. 点击 "Create Cluster"，等待创建完成（约 3-5 分钟）

### 1.3 创建数据库用户
1. 在左侧菜单点击 "Database Access"
2. 点击 "Add New Database User"
3. 选择 "Password" 认证方式
4. 设置用户名和密码（**务必记住这些信息**）
5. 用户权限选择 "Atlas admin" 或 "Read and write to any database"
6. 点击 "Add User"

### 1.4 配置网络访问
1. 在左侧菜单点击 "Network Access"
2. 点击 "Add IP Address"
3. 选择 "Allow Access from Anywhere"（输入 `0.0.0.0/0`）
   - 或者添加特定 IP（更安全，但需要知道服务器 IP）
4. 点击 "Confirm"

### 1.5 获取数据库连接字符串
1. 在左侧菜单点击 "Database"
2. 点击 "Connect"
3. 选择 "Connect your application"
4. 复制连接字符串，格式如下：
   ```
   mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority
   ```
5. **重要**：将 `<username>` 和 `<password>` 替换为您刚才创建的用户名和密码
6. 在连接字符串末尾添加数据库名称，例如：
   ```
   mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/restaurant?retryWrites=true&w=majority
   ```
   （`restaurant` 是数据库名，可以自定义）

---

## 🚂 第二步：部署后端（Railway 方案）

### 2.1 注册 Railway 账号
1. 访问：https://railway.app
2. 使用 GitHub 账号登录（推荐）或邮箱注册

### 2.2 创建新项目
1. 登录后点击 "New Project"
2. 选择 "Deploy from GitHub repo"（如果代码在 GitHub）
   - 或选择 "Empty Project" 然后上传代码

### 2.3 配置环境变量
1. 在项目设置中找到 "Variables" 标签
2. 添加以下环境变量：
   ```
   MONGODB_URI=您的MongoDB连接字符串
   JWT_SECRET=一个随机字符串（用于加密，可以生成随机字符串）
   PORT=3000
   NODE_ENV=production
   ```
   **生成 JWT_SECRET**：可以使用在线工具生成随机字符串，或使用命令：
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

### 2.4 配置启动命令
1. 在项目设置中找到 "Settings"
2. 设置 "Start Command" 为：
   ```
   node server.js
   ```
   或
   ```
   npm start
   ```

### 2.5 获取后端 API 地址
1. 部署成功后，Railway 会提供一个域名，例如：
   ```
   https://your-app-name.up.railway.app
   ```
2. **复制这个地址**，后续前端需要用到

### 2.6 配置静态文件上传（图片存储）
- Railway 的存储是临时的，建议使用云存储服务
- **方案 A**：使用 Cloudinary（免费）
  - 注册：https://cloudinary.com
  - 获取 API Key 和 Secret
  - 添加到环境变量：`CLOUDINARY_CLOUD_NAME`, `CLOUDINARY_API_KEY`, `CLOUDINARY_API_SECRET`
- **方案 B**：使用本地存储（Railway 临时，不推荐生产环境）

---

## 🌐 第三步：部署前端（Vercel 方案）

### 3.1 注册 Vercel 账号
1. 访问：https://vercel.com
2. 使用 GitHub 账号登录（推荐）

### 3.2 准备前端代码
1. 确保前端代码在 GitHub 仓库中
2. 在项目根目录创建 `vercel.json` 配置文件（如果需要）

### 3.3 部署到 Vercel
1. 登录 Vercel，点击 "Add New Project"
2. 导入您的 GitHub 仓库
3. 选择前端项目目录（如果前后端在同一仓库，选择 `frontend` 文件夹）
4. 配置构建设置：
   - **Framework Preset**: Create React App 或 Vite（根据您的构建工具）
   - **Build Command**: `npm run build`
   - **Output Directory**: `build` 或 `dist`（根据您的构建工具）

### 3.4 配置环境变量
1. 在项目设置中找到 "Environment Variables"
2. 添加：
   ```
   REACT_APP_API_URL=您的后端API地址（从Railway获取）
   ```
   例如：
   ```
   REACT_APP_API_URL=https://your-app-name.up.railway.app
   ```

### 3.5 部署
1. 点击 "Deploy"
2. 等待构建完成（约 2-3 分钟）
3. Vercel 会提供一个域名，例如：
   ```
   https://your-app-name.vercel.app
   ```

---

## 🔧 第四步：配置前后端连接

### 4.1 修改前端 API 配置
在前端代码中，确保 API 请求使用环境变量：
```javascript
const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:3000';
```

### 4.2 配置后端 CORS
确保后端允许来自 Vercel 域名的请求：
```javascript
const cors = require('cors');
app.use(cors({
  origin: [
    'https://your-app-name.vercel.app',
    'http://localhost:3000' // 开发环境
  ]
}));
```

### 4.3 重新部署
- 修改代码后，推送到 GitHub
- Vercel 和 Railway 会自动重新部署（如果已连接 GitHub）

---

## 🎯 第五步：测试部署

### 5.1 测试前端
1. 访问 Vercel 提供的域名
2. 检查页面是否正常加载
3. 测试浏览菜品功能

### 5.2 测试后端
1. 访问：`https://your-backend-url.railway.app/api/health`（如果有健康检查接口）
2. 或使用 Postman 测试 API

### 5.3 测试完整流程
1. 访问前端网站
2. 测试商家登录（使用商家端路由）
3. 测试添加菜品
4. 测试用户下单
5. 测试商家查看订单

---

## 🔄 替代方案：使用 Render 部署后端

如果 Railway 不可用，可以使用 Render：

### Render 部署步骤：
1. 访问：https://render.com
2. 注册账号（使用 GitHub）
3. 点击 "New +" → "Web Service"
4. 连接 GitHub 仓库
5. 配置：
   - **Name**: 自定义名称
   - **Environment**: Node
   - **Build Command**: `npm install`
   - **Start Command**: `node server.js`
6. 添加环境变量（同 Railway）
7. 点击 "Create Web Service"
8. 获取部署地址（格式：`https://your-app.onrender.com`）

---

## 📝 部署检查清单

- [ ] MongoDB Atlas 数据库已创建并配置
- [ ] 数据库连接字符串已获取
- [ ] 后端已部署到 Railway/Render
- [ ] 后端环境变量已配置
- [ ] 后端 API 地址已获取
- [ ] 前端已部署到 Vercel
- [ ] 前端环境变量已配置（API_URL）
- [ ] CORS 已配置允许前端域名
- [ ] 前后端连接测试通过
- [ ] 商家登录功能测试通过
- [ ] 用户下单功能测试通过

---

## 🆘 常见问题

### Q1: 后端部署后无法访问？
- 检查环境变量是否正确
- 检查端口配置（Railway/Render 会自动分配端口，使用 `process.env.PORT`）
- 检查 MongoDB 网络访问是否允许所有 IP

### Q2: 前端无法连接后端？
- 检查 `REACT_APP_API_URL` 环境变量是否正确
- 检查后端 CORS 配置是否包含前端域名
- 检查浏览器控制台错误信息

### Q3: 图片上传失败？
- 如果使用本地存储，Railway/Render 的存储是临时的
- 建议使用 Cloudinary 或其他云存储服务

### Q4: 如何更新代码？
- 推送到 GitHub
- Vercel 和 Railway/Render 会自动重新部署（如果已连接）
- 或手动触发重新部署

---

## 🎉 完成！

部署完成后，您的网站就可以通过 Vercel 提供的域名公开访问了！

**前端地址**：`https://your-app-name.vercel.app`  
**后端地址**：`https://your-app-name.up.railway.app`

---

## 📚 额外资源

- [Vercel 文档](https://vercel.com/docs)
- [Railway 文档](https://docs.railway.app)
- [MongoDB Atlas 文档](https://docs.atlas.mongodb.com)
- [Render 文档](https://render.com/docs)
